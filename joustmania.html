{% extends "basic.html" %}
{% block header %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joustmania Game Status</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .card h3 {
            margin-top: 0;
        }
        .main_status, .info_box, .error, .admin {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .main_status {
            border-left: 5px solid #4CAF50;
        }
        .info_box {
            display: none;
        }
        .error {
            color: #e74c3c;
            display: none;
        }
        button {
            background-color: #4CAF50;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            padding: 10px 20px;
        }
        button:hover {
            background-color: #45a049;
        }
        a button {
            text-decoration: none;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function updateStatus(){
            $.ajax({
                url: 'updateStatus',
                timeout: 2000,
                success: function(rawdata){
                    let info = JSON.parse(rawdata);
                    $('.main_status').show();
                    $('#game_mode').text(info.game_mode);
                    $('.info_box').hide();
                    $('.admin').hide();
                    $('.error').hide();

                    if (info.game_status === 'in_game') {
                        $('#gamebuttons').show();
                        if (info.game_mode === 'Joust Free-for-All' || info.game_mode === 'Ninja') {
                            $('#free4all').show();
                            $('#total_players').text(info.total_players);
                            $('#remaining_players').text(info.remaining_players);
                        } else if (info.game_mode === 'Tournament') {
                            $('#tournament').show();
                        } else if (info.game_mode === 'Zombies') {
                            $('#zombies').show();
                            $('#humans').text(info.humans);
                            $('#dead_zombies').text(info.dead_zombies);
                            $('#alive_zombies').text(info.alive_zombies);
                            $('#time_left').text(info.time_left);
                        } else if (info.game_mode === 'Commander') {
                            $('#commander').show();
                            $('#alpha_team').text(`${info.team_names[0]}: ${info.alpha_alive}/${info.alpha_players}`);
                            $('#alpha_od_status').text(`${info.team_names[0]} Overdrive: ${info.alpha_od_status}`);
                            $('#bravo_team').text(`${info.team_names[1]}: ${info.bravo_alive}/${info.bravo_players}`);
                            $('#bravo_od_status').text(`${info.team_names[1]} Overdrive: ${info.bravo_od_status}`);
                        } else if (info.game_mode === 'Ninja Bomb') {
                            $('#ninja').show();
                            $('#total_ninjas').text(info.total_players);
                        } else { //team mode without anything special
                            let team_info = '<br />';
                            if (info.game_mode === 'Werewolves') {
                                team_info += `Time to Reveal: ${info.time_to_reveal}<br /><br />`;
                            }
                            info.team_comp.forEach((t, i) => {
                                if (t[0] !== 0) {
                                    team_info += `${info.team_names[i]}: ${t[1]}/${t[0]}<br />`;
                                }
                            });
                            team_info += '<br />';
                            $('#teams').html(team_info);
                            $('#teams').show();
                        }

                    } else if (info.game_status === 'starting') {
                        $('#starting').show();
                        $('#player_count').text(info.alive_count);

                    } else if (info.game_status === 'ending') {
                        $('#ending').show();
                        $('#team_win').hide();
                        if (info.game_mode !== 'Joust Free-for-All' && info.winning_team !== -1) {
                            $('#team_win').show();
                            $('#team_win').text(`${info.team_names[info.winning_team]} win!`);
                        }

                    } else if (info.game_status === 'killed') {
                        $('#killed').show();

                    } else { //selection menu
                        if (admin_menu === true) {
                            $('.admin').show();
                        } else {
                            $('#mainmenu').show();
                            $('#menubuttons').show();
                            $('#move_count').text(info.move_count);
                            $('#game_count').text(info.game_count);
                            $('#ready_count').text(info.ready_count);
                            $('#alive_count').text(info.alive_count);
                            $('#git_hash').text(info.git_hash);
                        }
                    }
                },
                error: function(){
                    $('.main_status').hide();
                    $('.info_box').hide();
                    $('.admin').hide();
                    $('.error').show();
                    console.log('something broke!');
                }
            });
        }

        $(document).ready(function(){
            $('.main_status').hide();
            $('.info_box').hide();
            $('.error').hide();
            $('#menubuttons').show();
            admin_menu = false;

            $('#changemode').click(function(){
                $.get('changemode');
            });
            $('#startgame').click(function(){
                $.get('startgame');
            });
            $('#killgame').click(function(){
                $.get('killgame');
            });
            updateStatus();
            setInterval(updateStatus, 500);
        });
    </script>
</head>
<body>
{% endblock %}

{% block body %}
<div class="container">
    <div class="card main_status">
        <h3>Current mode: <span id="game_mode">Joust Null</span></h3>
    </div>

    <div class="card info_box" id="mainmenu">
        <p>Connected Moves (USB and BT): <span id="move_count">-999</span></p>
        <p>Active Moves: <span id="game_count">-999</span></p>
        <p>Ready Moves: <span id="ready_count">-999</span></p>
        <a href="/battery"><button type="button">Battery Status</button></a>
        <a href="/settings"><button type="button">Admin Settings</button></a>
    </div>

    <div class="card info_box" id="starting">
        <p>Total Players: <span id="player_count">-999</span></p>
        <p>Game Starting!</p>
    </div>

    <div class="card info_box" id="free4all">
        <p>Total Players: <span id="total_players">-999</span></p>
        <p>Players remaining: <span id="remaining_players">-999</span></p>
    </div>

    <div class="card info_box" id="teams"></div>

    <div class="card info_box" id="zombies">
        <p>Time remaining: <span id="time_left">OVER 9000</span></p>
        <p>Humans: <span id="humans">-999</span></p>
        <p>Dead Zombies: <span id="dead_zombies">-999</span></p>
        <p>Alive Zombies: <span id="alive_zombies">-999</span></p>
    </div>

    <div class="card info_box" id="commander">
        <p><span id="alpha_team">Alpha Team: -999/-999</span></p>
        <p><span id="alpha_od_status">Alpha Team Overdrive: lol</span></p>
        <p><span id="bravo_team">Bravo Team: -999/-999</span></p>
        <p><span id="bravo_od_status">Bravo Team Overdrive: lol</span></p>
    </div>

    <div class="card info_box" id="ninja">
        <p>Total Players: <span id="total_ninjas">-999</span></p>
    </div>

    <div class="card info_box" id="tournament">
        <p>Status coming soon to a web browser near you!</p>
    </div>

    <div class="card info_box" id="ending">
        <p>Game over!</p>
        <p><span id="team_win">Null Team wins!</span></p>
    </div>

    <div class="card info_box" id="killed">
        <p>Game Killed!</p>
    </div>

    <div class="card info_box" id="menubuttons">
        <button id="changemode">Change Mode</button>
        <button id="startgame">Start Game</button>
    </div>

    <div class="card admin">
        <h3>Administrator Only:</h3>
        <button id="killgame">Kill Game</button>
    </div>

    <div class="card error">
        <p>There was an error!</p>
    </div>
</div>
{% endblock %}
</body>
</html>
